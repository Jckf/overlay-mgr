services:
  ####################
  # Web server       #
  ####################
  nginx:
    build:
      context: ./
      dockerfile: nginx.dockerfile

    ports:
      - "80:80"

    volumes:
      - ./static:/var/www/static

    depends_on:
      - php

  ####################
  # App server       #
  ####################
  php:
    build:
      context: ./
      dockerfile: php.dockerfile

    #ports:
    #  - "8080:8080"

    volumes:
      - .:/var/www

    depends_on:
      mysql:
        condition: service_healthy

  ####################
  # Database server  #
  ####################
  mysql:
    build:
      context: ./
      dockerfile: mysql.dockerfile

    environment:
      MYSQL_RANDOM_ROOT_PASSWORD: "yes"

    healthcheck:
      test: [ "CMD-SHELL", "mysqladmin ping -h 127.0.0.1 -u overlay-mgr -poverlay-mgr --silent" ]
      interval: 3s
      timeout: 1s
      retries: 10
